<app-header [sumirTitulo]="true"></app-header>

<div class="layout-wrapper">

    <!-- OVERLAY (Fundo escuro no mobile quando menu abre) -->
    <div class="sidebar-overlay" [class.active]="isSidebarOpen()" (click)="toggleSidebar()">
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar" [class.open]="isSidebarOpen()">
        <div class="sidebar-header">
            <div class="brand-logo">
                <mat-icon>school</mat-icon>
                <span>GESTOR</span>
            </div>
            <button class="close-btn" (click)="toggleSidebar()">
                <mat-icon>close</mat-icon>
            </button>
        </div>

        <nav class="sidebar-nav">
            @if(auth.isAdmin()){

           
            <p class="nav-label">CADASTROS</p>

            <a routerLink="/cadastro-login" routerLinkActive="active" (click)="closeSidebar()">
                <mat-icon>person</mat-icon> Administrador
            </a>

            <a routerLink="/cadastro-aluno" routerLinkActive="active" (click)="closeSidebar()">
                <mat-icon>person_add</mat-icon> Aluno
            </a>

            <a routerLink="/cadastro-professor" routerLinkActive="active" (click)="closeSidebar()">
                <mat-icon>work</mat-icon> Professor
            </a>
            <a routerLink="/cadastro-servidor" routerLinkActive="active" (click)="closeSidebar()">
                <mat-icon>badge</mat-icon> Servidor
            </a>
            <a routerLink="/cadastro-disciplina" routerLinkActive="active" (click)="closeSidebar()">
                <mat-icon>book</mat-icon> Disciplina
            </a>
            
            <a routerLink="/cadastro-turma" routerLinkActive="active" (click)="closeSidebar()">
                <mat-icon>class</mat-icon> Turma
            </a>
            
        }

            <p class="nav-label">GESTÃO</p>
            @if(auth.isAdmin()){
                <a routerLink="/gerenciar-usuarios" routerLinkActive="active" (click)="closeSidebar()">
                    <mat-icon>manage_accounts</mat-icon> Usuários
                </a>
            }
            <a routerLink="/turmas" routerLinkActive="active" (click)="closeSidebar()">
                <mat-icon>view_list</mat-icon> Lista de Turmas
            </a>
            <a routerLink="/nova-noticia" routerLinkActive="active" (click)="closeSidebar()">
                <mat-icon>campaign</mat-icon> Notícias/Eventos
            </a>
        </nav>

        <div class="sidebar-footer">
            <span class="version">Versão 2.0</span>
        </div>
    </aside>

    <!-- CONTEÚDO PRINCIPAL -->
    <main class="main-content">

        <!-- HEADER DO PAINEL -->
        <header class="panel-header">
            <div class="header-left">
                <button class="hamburger-btn" (click)="toggleSidebar()">
                    <mat-icon>menu</mat-icon>
                </button>
                <div class="page-title">
                    <h2>Painel de Controle</h2>
                    <span>Visão geral do sistema</span>
                </div>
            </div>

            <!-- Botão de Novo Rápido (Responsivo) -->
            <div class="header-actions">
                <button class="btn-novo-rapido"
                    [routerLink]="viewMode() === 'alunos' ? '/cadastro-aluno' : viewMode() === 'professores' ? '/cadastro-professor' : '/cadastro-servidor'">
                    <mat-icon>add</mat-icon>
                    <span class="btn-text">Novo {{ viewMode() === 'alunos' ? 'Aluno' : viewMode() === 'professores' ?
                        'Professor' : 'Servidor' }}</span>
                </button>
            </div>
        </header>

        <!-- CARDS DE ESTATÍSTICA -->
        <section class="stats-grid">
            <div class="stat-card blue-card" (click)="toggleView('alunos')" [class.selected]="viewMode() === 'alunos'">
                <div class="icon-box">
                    <mat-icon>school</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="label">Total de Alunos</span>
                    <span class="number">{{ totalAlunos() }}</span>
                </div>
                <div class="indicator" *ngIf="viewMode() === 'alunos'"></div>
            </div>

            <div class="stat-card yellow-card" (click)="toggleView('professores')"
                [class.selected]="viewMode() === 'professores'">
                <div class="icon-box">
                    <mat-icon>person</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="label">Professores</span>
                    <span class="number">{{ totalProfessores() }}</span>
                </div>
                <div class="indicator" *ngIf="viewMode() === 'professores'"></div>
            </div>

            <div class="stat-card navy-card" (click)="toggleView('servidores')"
                [class.selected]="viewMode() === 'servidores'">
                <div class="icon-box">
                    <mat-icon>badge</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="label">Servidores</span>
                    <span class="number">{{ totalServidores() }}</span>
                </div>
                <div class="indicator" *ngIf="viewMode() === 'servidores'"></div>
            </div>
        </section>

        <!-- ÁREA DE DADOS (TABELA) -->
        <section class="data-card">

            <!-- BARRA DE FERRAMENTAS -->
            <div class="toolbar">
                <div class="search-box">
                    <mat-icon>search</mat-icon>
                    <input type="text" [(ngModel)]="searchQuery" (input)="onSearch()"
                        placeholder="Buscar por Nome, CPF ou Matrícula...">
                </div>

                <div class="filter-box">
                    <select [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()">
                        <option *ngFor="let opt of itemsPerPageOptions" [value]="opt">{{ opt }} itens</option>
                    </select>
                </div>
            </div>

            <!-- MENSAGENS -->
            <div *ngIf="successMessage()" class="alert-box success">
                <mat-icon>check_circle</mat-icon> {{ successMessage() }}
            </div>
            <div *ngIf="errorMessage()" class="alert-box error">
                <mat-icon>error</mat-icon> {{ errorMessage() }}
            </div>

            <!-- LOADING -->
            <div *ngIf="isLoading()" class="loading-state">
                <div class="spinner"></div>
                <p>Carregando dados...</p>
            </div>

            <!-- TABELA RESPONSIVA -->
            <div class="table-responsive" *ngIf="!isLoading()">

                <!-- TABELA ALUNOS -->
                <table class="custom-table" *ngIf="viewMode() === 'alunos' && filteredAlunos.length > 0">
                    <thead>
                        <tr>
                            <th>Matrícula</th>
                            <th>Nome Completo</th>
                            <th>CPF</th>
                            <th class="hide-mobile">Idade</th>
                            <th class="hide-mobile">Responsável</th>

                            @if(auth.isAdmin()){
                            <th>Acesso</th>
                            <th class="text-end">Ações</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let aluno of filteredAlunos">
                            <td><span class="badge-id">{{ aluno.matricula }}</span></td>
                            <td>
                                <div class="user-info">
                                    <div class="avatar-circle">{{ aluno.nome.charAt(0) }}</div>
                                    <span>{{ aluno.nome }}</span>
                                </div>
                            </td>
                            <td>{{ formatCpfMasked(aluno.cpf) }}</td>
                            <td class="hide-mobile">{{ calcularIdade(aluno.data_nascimento) }} anos</td>
                            <td class="hide-mobile">{{ aluno.nome_responsavel }}</td>

                            @if(auth.isAdmin()){


                            <!-- Coluna Acesso -->
                            <td>
                                <button class="btn-link-access" [class.linked]="aluno.email_usuario"
                                    (click)="openCadAlunoLogin(aluno)" [disabled]="aluno.email_usuario">
                                    <mat-icon>{{ aluno.email_usuario ? 'check_circle' : 'add_link' }}</mat-icon>
                                    {{ aluno.email_usuario ? 'Ativo' : 'Criar' }}
                                </button>
                            </td>

                            <!-- Ações -->
                            <td class="text-end">
                                <button class="btn-icon edit" (click)="openEditAlunoDialog(aluno)" matTooltip="Editar">
                                    <mat-icon>edit</mat-icon>
                                </button>
                                <button class="btn-icon delete" (click)="deleteAluno(aluno)" matTooltip="Excluir">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                            }
                        </tr>
                    </tbody>
                </table>

                <!-- TABELA PROFESSORES -->
                <table class="custom-table" *ngIf="viewMode() === 'professores' && filteredProfessores.length > 0">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th class="hide-mobile">Email</th>
                            <th class="hide-mobile">Telefone</th>
                            @if(auth.isAdmin()){
                            <th>Acesso</th>
                            <th class="text-end">Ações</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let prof of filteredProfessores">
                            <td>
                                <div class="user-info">
                                    <div class="avatar-circle prof">{{ prof.nome.charAt(0) }}</div>
                                    <span>{{ prof.nome }}</span>
                                </div>
                            </td>
                            <td>{{ formatCpfMasked(prof.cpf) }}</td>
                            <td class="hide-mobile">{{ prof.email }}</td>
                            <td class="hide-mobile">{{ formatTelefone(prof.telefone) }}</td>

                            @if(auth.isAdmin()){

                            <td>
                                <button class="btn-link-access" [class.linked]="prof.email_usuario"
                                    (click)="openCadLoginProfessor(prof)" [disabled]="prof.email_usuario">
                                    <mat-icon>{{ prof.email_usuario ? 'check_circle' : 'add_link' }}</mat-icon>
                                    {{ prof.email_usuario ? 'Ativo' : 'Criar' }}
                                </button>
                            </td>

                            <td class="text-end">
                                <button class="btn-icon edit" (click)="openEditProfessorDialog(prof)">
                                    <mat-icon>edit</mat-icon>
                                </button>
                                <button class="btn-icon delete" (click)="deleteProfessor(prof)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                            }
                        </tr>
                    </tbody>
                </table>

                <!-- TABELA SERVIDORES -->
                <table class="custom-table" *ngIf="viewMode() === 'servidores' && filteredServidores.length > 0">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Função</th>
                            <th class="hide-mobile">Email</th>

                            @if(auth.isAdmin()){
                            <th>Acesso</th>
                            <th class="text-end">Ações</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let serv of filteredServidores">
                            <td>
                                <div class="user-info">
                                    <div class="avatar-circle serv">{{ serv.nome.charAt(0) }}</div>
                                    <span>{{ serv.nome }}</span>
                                </div>
                            </td>
                            <td><span class="badge-funcao">{{ serv.funcao }}</span></td>
                            <td class="hide-mobile">{{ serv.email }}</td>
                            @if(auth.isAdmin()){
                            <td>
                                <button class="btn-link-access" [class.linked]="serv.email_usuario"
                                    (click)="openCadLoginServidores(serv)" [disabled]="serv.email_usuario">
                                    <mat-icon>{{ serv.email_usuario ? 'check_circle' : 'add_link' }}</mat-icon>
                                    {{ serv.email_usuario ? 'Ativo' : 'Criar' }}
                                </button>
                            </td>

                            <td class="text-end">
                                <button class="btn-icon edit" (click)="openEditServidorDialog(serv)">
                                    <mat-icon>edit</mat-icon>
                                </button>
                                <button class="btn-icon delete" (click)="deleteServidor(serv)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                            }
                        </tr>
                    </tbody>
                </table>

                <!-- EMPTY STATE -->
                <div *ngIf="(viewMode() === 'alunos' && filteredAlunos.length === 0) || 
                            (viewMode() === 'professores' && filteredProfessores.length === 0) ||
                            (viewMode() === 'servidores' && filteredServidores.length === 0)" class="empty-state">
                    <mat-icon>search_off</mat-icon>
                    <p>Nenhum registro encontrado.</p>
                </div>

            </div>

            <!-- PAGINAÇÃO -->
            <div class="pagination-footer" *ngIf="currentTotal > 0">
                <span class="page-info">
                    Total: <strong>{{ currentTotal }}</strong> registros
                </span>

                <div class="page-actions">
                    <button class="page-btn" (click)="previousPage()" [disabled]="currentPage() === 1">
                        <mat-icon>chevron_left</mat-icon>
                    </button>
                    <span class="current-page">Pág {{ currentPage() }}</span>
                    <button class="page-btn" (click)="nextPage()" [disabled]="currentPage() === totalPages()">
                        <mat-icon>chevron_right</mat-icon>
                    </button>
                </div>
            </div>

        </section>

    </main>
</div>